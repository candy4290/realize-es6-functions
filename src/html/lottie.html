<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Lottie + Canvas åŠ¨ç”»é€å¸§å¯¼å‡ºä¸º ZIP</title>
  <style>
    #canvas-container {
      width: 500px;
      height: 500px;
      margin: 50px auto;
      border: 1px solid #ccc;
    }
    #progress-container {
      width: 500px;
      margin: 20px auto;
    }
    #progress {
      width: 100%;
      height: 20px;
    }
    #progress-label {
      text-align: center;
      font-size: 14px;
      margin-top: 5px;
    }
  </style>
</head>
<body>

  <h2 style="text-align:center;">ğŸ¨ Lottie + Canvas åŠ¨ç”»é€å¸§å¯¼å‡ºä¸º ZIP</h2>
  <div id="canvas-container"></div>
  <button id="export">å¯¼å‡ºæ‰€æœ‰å¸§ä¸º ZIP</button>

  <!-- Progress Bar -->
  <div id="progress-container">
    <progress id="progress" value="0" max="100"></progress>
    <div id="progress-label">0% å®Œæˆ</div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.10.2/lottie.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>

  <script>
    let anim;
    let canvas;
    let currentFrame = 0;
    let totalFrames;
    let zip;
    let exportInProgress = false;

    // 1. åˆå§‹åŒ– Lottie åŠ¨ç”»
    anim = lottie.loadAnimation({
      container: document.getElementById('canvas-container'),
      renderer: 'canvas',
      loop: false,
      autoplay: false,
      path: 'https://assets8.lottiefiles.com/packages/lf20_myejiggj.json'  // æ›¿æ¢ä¸ºä½ è‡ªå·±çš„åŠ¨ç”» JSON
    });

    anim.addEventListener('DOMLoaded', () => {
      canvas = document.querySelector('#canvas-container canvas');
    });

    // 2. å¯¼å‡ºæ¯ä¸€å¸§å¹¶æ‰“åŒ…ä¸º ZIP
    document.getElementById('export').addEventListener('click', async () => {
      if (exportInProgress) return;
      exportInProgress = true;

      totalFrames = Math.floor(anim.getDuration(true)); // è·å–åŠ¨ç”»æ€»å¸§æ•°
      zip = new JSZip(); // åˆ›å»º ZIP å®ä¾‹

      console.log(`å‡†å¤‡å¯¼å‡º ${totalFrames} å¸§...`);
      currentFrame = 0;

      // å¯åŠ¨å¸§é‡‡é›†
      requestAnimationFrame(exportFrames);
    });

    function exportFrames() {
      // è·³åˆ°å½“å‰å¸§
      anim.goToAndStop(currentFrame, true);
      
      // æ¸²æŸ“åé‡‡é›†å›¾åƒ
      const dataURL = canvas.toDataURL('image/png');
      const base64 = dataURL.split(',')[1];  // å»é™¤ data:image/png;base64, éƒ¨åˆ†
      zip.file(`frame_${String(currentFrame).padStart(3, '0')}.png`, base64, { base64: true });

      console.log(`å¯¼å‡ºå¸§ ${currentFrame + 1} / ${totalFrames}`);

      // æ›´æ–°è¿›åº¦æ¡
      const progress = (currentFrame / totalFrames) * 100;
      document.getElementById('progress').value = progress;
      document.getElementById('progress-label').textContent = `${Math.round(progress)}% å®Œæˆ`;

      currentFrame++;

      // å¦‚æœè¿˜æœ‰å¸§æœªå¯¼å‡ºï¼Œç»§ç»­è°ƒç”¨ requestAnimationFrame
      if (currentFrame < totalFrames) {
        requestAnimationFrame(exportFrames);
      } else {
        // å®Œæˆå¯¼å‡ºï¼Œç”Ÿæˆ ZIP æ–‡ä»¶å¹¶è§¦å‘ä¸‹è½½
        zip.generateAsync({ type: "blob" }).then(content => {
          const a = document.createElement('a');
          a.href = URL.createObjectURL(content);
          a.download = 'lottie_frames.zip';
          a.click();

          console.log('âœ… ZIP æ–‡ä»¶å·²å‡†å¤‡å¥½å¹¶å¼€å§‹ä¸‹è½½');
          exportInProgress = false; // å¯¼å‡ºç»“æŸ
        });
      }
    }
  </script>

</body>
</html>
